-- *************************************************************
-- Safe updates
-- *************************************************************
set SQL_SAFE_UPDATES=0;
set FOREIGN_KEY_CHECKS=0;

use class_examples;

create table users (
    user_id int primary key,
    
    username varchar(50) not null,
    department varchar(50),
    is_active boolean
);


create table policies (
    policy_id varchar(10) primary key,
    
    name varchar(100) not null,
    rule text
);


create table alerts (
    alert_id varchar(10) primary key,
    
    type varchar(100),
    user_id int,
    policy_id varchar(10),
   
    foreign key (user_id) references users(user_id),
    foreign key (policy_id) references policies(policy_id)
);

insert into users (user_id, username, department, is_active) values
(701, 'Emma', 'Engineering', true),
(702, 'Michael', 'Marketing', true),
(703, 'Eve', 'Accounting', false),
(704, 'Paul', 'Finance', true),
(705, 'Jackie', 'HR', false),
(706, 'Olivia', 'Operations', true);  -- -----> user with no alerts

insert into policies (policy_id, name, rule) values
('pol-101', 'Admin Login Policy', 'Restrict after-hours admin logins.'),
('pol-202', 'Data Exfiltration Policy', 'Block large file transfers to external domains.'),
('pol-303', 'Endpoint Security Policy', 'Flag unauthorized software execution.'),
('pol-404', 'Geo-Location Policy', 'Alert on logins from restricted countries.'),
('pol-505', 'Privilege Escalation Policy', 'Monitor failed attempts to gain root access.'),
('pol-606', 'Phishing Policy', 'Block emails with suspicious links.'); -- ----> Policy with no alerts

select * from policies;

insert into alerts (alert_id, type, user_id, policy_id) values
('t-111', 'Admin Login', 701, 'pol-101'),
('t-112', 'Large Transfer', 702, 'pol-202'),
('t-113', 'Unauthorized Executable', 703, 'pol-303'),
('t-114', 'Geo-Violation', 704, 'pol-404'),
('t-115', 'PrivEsc Failure', 704, 'pol-505'),
('t-116', 'Admin Login (Failed)', 705, 'pol-101'),
('t-117', 'Geo-Violation', 701, 'pol-404');


-- =========================================================================
-- Query 1: Identify all alerts generated by inactive users. (INNER JOIN)
-- =========================================================================
select
    alerts.alert_id,
    alerts.type as alert_type,
    users.username,
    users.department,
    users.is_active,
    policies.name as policy_name,
    policies.rule as policy_rule
    
from
    alerts inner join users on alerts.user_id = users.user_id
           inner join  policies on alerts.policy_id = policies.policy_id
where
    users.is_active = false;
    
    
    

-- =========================================================================
-- Query 2: Find users with no alerts.  (LEFT JOIN)
-- =========================================================================
select
    users.username,
    alerts.alert_id,
    alerts.type as alert_type
    
from users left join 
    alerts on users.user_id = alerts.user_id
    
where
    alerts.alert_id is null; 
    
    
    
 
 -- =========================================================================
 -- Query 3: Find policies not associated with any alerts.   (RIGHT JOIN)
 -- =========================================================================
 
select
    policies.policy_id,
    policies.name,
    alerts.alert_id
from
    alerts
right join
    policies on alerts.policy_id = policies.policy_id
where
    alerts.alert_id is null;
